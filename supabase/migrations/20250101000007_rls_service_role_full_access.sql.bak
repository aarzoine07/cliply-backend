-- full access for service-role key
do $$
begin
  execute format('grant all on all tables in schema public to service_role;');
  execute format('grant all on all sequences in schema public to service_role;');
end $$;

-- âœ… Allow service role to bypass RLS on all public tables
do $$
declare
  r record;
begin
  for r in select tablename from pg_tables where schemaname = 'public' loop
    execute format('alter table public.%I enable row level security;', r.tablename);

    if not exists (
      select 1
      from pg_policies
      where polname = format('service_role_full_access_%s', r.tablename)
    ) then
      execute format('create policy "service_role_full_access_%I"
        on public.%I
        for all
        to service_role
        using (true)
        with check (true);', r.tablename, r.tablename);
    end if;
  end loop;
end $$;
