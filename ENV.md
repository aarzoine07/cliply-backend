# Environment Variables

This document describes all environment variables used by the Cliply backend.

**Single Source of Truth**: All environment variables are defined in `packages/shared/src/env.ts`. Server-side code should use the shared env module or app-specific adapters instead of accessing `process.env` directly.

## Getting Started

**New to the project?** Follow these steps to configure your local environment:

1. **Copy the template**: `cp .env.example .env.local`
2. **Fill in required values** using this document as a reference
3. **For tests**: Create `.env.test` following the guide in `TEST_ENV_SETUP.md`

The `.env.example` file in the repo root contains all environment variables with helpful comments and organization.

## Quick Reference

- **Server-side code (web/worker)**: Import from `@cliply/shared/env` or use app adapters (`apps/web/src/lib/env.ts`, `apps/worker/src/env.ts`)
- **Client-side code (Next.js)**: Use `publicEnv` from `apps/web/src/lib/env.ts` (only `NEXT_PUBLIC_*` variables)

## Required Environment Variables

These variables must be set for the application to start:

### Supabase Configuration

| Variable | Description | Example |
|----------|-------------|---------|
| `SUPABASE_URL` | Supabase project URL | `https://xxx.supabase.co` |
| `SUPABASE_ANON_KEY` | Supabase anonymous key | `eyJhbGc...` |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase service role key (server-side only) | `eyJhbGc...` |

**Source**: Supabase Dashboard → Settings → API

### TikTok Token Encryption

| Variable | Description | Example |
|----------|-------------|---------|
| `TIKTOK_ENCRYPTION_KEY` | Base64-encoded 32-byte key for encrypting TikTok tokens at rest | Generate with: `node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"` |

**Required**: Yes (for TikTok OAuth to work)

## Optional Environment Variables

### Core Configuration

| Variable | Description | Default | Example |
|----------|-------------|---------|---------|
| `NODE_ENV` | Node environment | `development` | `production`, `development`, `test` |
| `LOG_SAMPLE_RATE` | Log sampling rate (0.0-1.0) | `1` | `0.1` (10% sampling) |

### Worker Configuration

| Variable | Description | Default | Example |
|----------|-------------|---------|---------|
| `WORKER_POLL_MS` | Worker poll interval (milliseconds) | - | `1000` |
| `WORKER_HEARTBEAT_MS` | Worker heartbeat interval (milliseconds) | - | `5000` |
| `WORKER_RECLAIM_MS` | Worker job reclaim interval (milliseconds) | - | `60000` |
| `WORKER_STALE_SECONDS` | Seconds before a job is considered stale | - | `120` |

### External Services

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `SENTRY_DSN` | Sentry error monitoring DSN | No | `https://xxx@sentry.io/xxx` |
| `DATABASE_URL` | Direct database connection URL | No | `postgresql://...` |
| `STRIPE_SECRET_KEY` | Stripe secret API key | No* | `sk_test_...` |
| `STRIPE_WEBHOOK_SECRET` | Stripe webhook signing secret | No* | `whsec_...` |
| `DEEPGRAM_API_KEY` | Deepgram API key for transcription | No | `xxx` |
| `OPENAI_API_KEY` | OpenAI API key | No | `sk-...` |

*Required for billing features

### YouTube/Google OAuth

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `GOOGLE_CLIENT_ID` | Google OAuth client ID | No* | `xxx.apps.googleusercontent.com` |
| `GOOGLE_CLIENT_SECRET` | Google OAuth client secret | No* | `GOCSPX-xxx` |
| `YOUTUBE_OAUTH_REDIRECT_URL` | YouTube OAuth redirect URL | No* | `https://app.cliply.ai/api/auth/youtube/callback` |

*Required for YouTube publishing

### TikTok OAuth

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `TIKTOK_CLIENT_ID` | TikTok OAuth client key | No* | `xxx` |
| `TIKTOK_CLIENT_SECRET` | TikTok OAuth client secret | No* | `xxx` |
| `TIKTOK_OAUTH_REDIRECT_URL` | TikTok OAuth redirect URL (server-side) | No* | `https://app.cliply.ai/api/auth/tiktok/callback` |
| `TIKTOK_TOKEN_URL` | TikTok token endpoint URL | No | `https://open.tiktokapis.com/v2/oauth/token/` |

*Required for TikTok publishing

### Cron & Automation

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `CRON_SECRET` | Secret for authenticating cron job requests | No* | `xxx` (auto-generated by Vercel) |
| `VERCEL_AUTOMATION_BYPASS_SECRET` | Secret for bypassing Vercel protection in testing | No | `xxx` |

*Required for scheduled publishing via Vercel Cron

### Next.js Public Variables (Client-Side)

These variables are exposed to the browser and must be prefixed with `NEXT_PUBLIC_`:

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase URL (for client-side) | Yes | `https://xxx.supabase.co` |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase anon key (for client-side) | Yes | `eyJhbGc...` |
| `NEXT_PUBLIC_TIKTOK_REDIRECT_URL` | TikTok OAuth redirect URL (for client-side) | No* | `https://app.cliply.ai/api/auth/tiktok/connect/callback` |
| `NEXT_PUBLIC_APP_URL` | Application public URL | No | `https://app.cliply.ai` |
| `NEXT_PUBLIC_SENTRY_DSN` | Sentry DSN (for client-side) | No | `https://xxx@sentry.io/xxx` |

*Required if using TikTok OAuth

## Environment Setup

### Development

The easiest way to get started is to use the provided template:

```bash
# Copy the template
cp .env.example .env.local

# Edit .env.local and fill in the required values
# Required minimum for local development:
# - SUPABASE_URL
# - SUPABASE_ANON_KEY
# - SUPABASE_SERVICE_ROLE_KEY
# - TIKTOK_ENCRYPTION_KEY (if using TikTok features)
```

The `.env.example` file contains all available environment variables organized by category with helpful comments. You don't need to set all of them for local development—start with the required Supabase credentials and add others as needed.

### Generate TikTok Encryption Key

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

### Production

Set all required variables in your deployment platform (Vercel, etc.):

- Vercel Dashboard → Settings → Environment Variables
- Add all required variables for Preview + Production environments

**Note**: `NEXT_PUBLIC_*` variables must be set for both server and client-side access in Next.js.

## Code Usage Examples

### Server-Side (API Routes, Server Components)

```typescript
// Web app
import { serverEnv } from "@/lib/env";

const url = serverEnv.SUPABASE_URL;
const secret = serverEnv.STRIPE_SECRET_KEY;

// Worker
import { env } from "../env";

const url = env.SUPABASE_URL;
const key = env.TIKTOK_ENCRYPTION_KEY;
```

### Client-Side (React Components)

```typescript
import { publicEnv } from "@/lib/env";

const supabaseUrl = publicEnv.NEXT_PUBLIC_SUPABASE_URL;
const appUrl = publicEnv.NEXT_PUBLIC_APP_URL;
```

### Shared Package

```typescript
import { getEnv } from "@cliply/shared/env";

const env = getEnv();
const url = env.SUPABASE_URL;
```

## Validation & Error Handling

The environment schema validates all variables on first access. If required variables are missing or invalid, the application will:

1. **Fail fast** - Throw a clear error during startup
2. **Provide detailed messages** - List which variables are missing or invalid
3. **Prevent silent failures** - No default values for critical config

Example error:
```
Environment variable validation failed:
  SUPABASE_URL: Required
  TIKTOK_ENCRYPTION_KEY: Required
  SUPABASE_ANON_KEY: String must contain at least 20 character(s)

Please check your .env file or environment configuration.
```

## Migration Notes

### TikTok Variables

- `TIKTOK_CLIENT_KEY` → `TIKTOK_CLIENT_ID` (standardized name)
- Legacy code may still reference `TIKTOK_CLIENT_KEY` but should use `TIKTOK_CLIENT_ID`

### NEXT_PUBLIC Variables

- `NEXT_PUBLIC_SUPABASE_URL` should match `SUPABASE_URL` (same value, different contexts)
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` should match `SUPABASE_ANON_KEY` (same value, different contexts)

## Environment-Specific Files

- `.env.example` - **Template with all variables** (committed to git) ✅
  - Start here! Copy this to `.env.local` for development
- `.env.local` - Local development (git-ignored)
  - Your personal dev environment—not committed
- `.env.test` - Test environment (git-ignored)
  - See `TEST_ENV_SETUP.md` for test-specific setup
- `.env.production` - Production environment (git-ignored, typically not used)
  - Production uses platform env vars (Vercel, etc.)

## Testing

For tests, you can override environment variables:

```typescript
process.env.SUPABASE_URL = "http://localhost:54321";
process.env.TIKTOK_ENCRYPTION_KEY = "test-key-base64-encoded-32-bytes-here";
import { clearEnvCache } from "@cliply/shared/env";
clearEnvCache(); // Clear cache to pick up new values
const env = getEnv(); // Will use new values
```

## Security Notes

1. **Never commit secrets** - All `.env` files except `.env.example` are git-ignored
2. **Service role key** - Never expose `SUPABASE_SERVICE_ROLE_KEY` to client-side code
3. **Encryption keys** - Keep `TIKTOK_ENCRYPTION_KEY` secret and rotate periodically
4. **Cron secrets** - Keep `CRON_SECRET` private; only internal services should know it
